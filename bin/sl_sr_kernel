#!/usr/bin/perl
use strict;
use warnings;
use Getopt::Long;

my $from = 'Kernel:stable';
my $to = 'openSUSE:Factory';

GetOptions("from=s" => \$from,
	"to=s"   => \$to) or
	die("Error in command line arguments\n");


my @opts = qw/cmd=diff unified=1 expand=0 filelimit=0 file[]=kernel-source.changes/;
push @opts, "oproject=$to";

my @cmd = qw/osc api -X POST/;
push @cmd, "/source/$from/kernel-source?" . join "&", @opts;

print join " ", @cmd, "\n";

open(my $DIFF, '-|', @cmd) or die "cannot rdiff";
# skip header
for (my $i = 0; $i < 4; $i++) {
	<$DIFF>;
}
my %bsc;
my $start = 1;
while (<$DIFF>) {
	map { $bsc{$_} = 1 } /(?:bsc|boo|fate)#\d+|jsc#\w+-\d+'/g if /^\+/;
	if (/-{10,}/) {
		$start = 1;
		print "\n";
		next;
	}
	if (/^\+/) {
		print $_ if ($start > 2 && $start < 5);
		$start++;
	}
}
close $DIFF;

print "\nWrite summary: ";
my $msg = <STDIN>;
chomp $msg;
$msg .= "; bugs: " . join(" ", sort keys %bsc) if (scalar %bsc);
print "\n$msg\nOK? ";

<STDIN>;

@cmd = ('osc', 'sr', '-m', $msg, $from, 'kernel-source', $to);

open(my $sr, '-|', @cmd) or die "cannot run ", join(" ", @cmd);
while (<$sr>) {
	print;
	system('oscopen', $1) if /.* id ([0-9]+)/;
}
close $sr;

1;
